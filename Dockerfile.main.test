# Updated Dockerfile for main Flask application
# Lighter weight - streamlined microservice architecture
FROM python:3.11-slim-bookworm

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1

# Basic system dependencies for video processing
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    && rm -rf /var/lib/apt/lists/*

# App workspace
WORKDIR /app

# Python dependencies - optimized for HTTP microservices
COPY requirements_main.txt ./
RUN python -m pip install --upgrade pip && \
    pip install --no-cache-dir -r requirements_main.txt

# App files
COPY templates/ templates/
COPY static/dist/ static/dist/        
COPY video_agent_gemini.py app.py http_tool_manager.py ./

# Runtime dirs
RUN mkdir -p uploads processed logs && \
    chmod 777 uploads processed logs

# Non-root user
RUN groupadd -r app && useradd -r -g app app && \
    chown -R app:app /app && chmod -R 775 /app

# Entrypoint (root-owned, on PATH)
COPY docker-entrypoint-test.sh /usr/local/bin/docker-entrypoint.sh
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

USER app

EXPOSE 5001

HEALTHCHECK --interval=30s --timeout=10s --start-period=15s --retries=3 \
    CMD curl -f http://localhost:5001/health || exit 1

ENTRYPOINT ["docker-entrypoint.sh"]
